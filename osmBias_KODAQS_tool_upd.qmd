---
title: "osmBias"
subtitle: "Bias in the Map, Bias in the Results? Validating OpenStreetMap POI Data for
Individual-Level Survey-Based Analysis"
author:
  - name: "Daria Dementeva"
  - name: "Anne-Kathrin Stroppe"
  - name: "author 3"
image: images/tool_icon.png #takes from a folder "images" in your github repository the tool icon file  
date: "`r format(Sys.Date(), '%B %d, %Y')`"
format:
  html: default
  pdf: default
# bibliography: references.bib
biblio-style: apa
---

# At a glance

**How do differences in point of interest (POI) data sources affect analytical results?** \
This tool offers a hands-on, step-by-step workflow to help users compare POI data from OpenStreetMap (OSM) with administrative POI and built environment datasets. The tutorial walks users through the following steps:\

**Step 1a: Prepare the OSM POI data**\
Access OSM POI data, load it into the R  environment, clean and standardize the OSM geometries, and assign POIs to administrative geographic units so they can be compared with official POI data.\

**Step 1b: Create comparable POI indicators**\
Construct the same POI-based measures (e.g., counts) using both OSM and official POI datasets.\

**Step 2: Assess the standalone quality of POI indicators: Coverage**\
Compare POI indicators to identify differences in coverage per administrative geographic unit.\

**Step 3: Link to survey data**\
Link POI-based measures from OSM and official data to survey responses at the respondent's administrative geographic unit of residence.\

**Step 4: Assess impacts on analytical results**\
Estimate parallel regression models using OSM-based and official POI-based indicators. Compare model coefficients, statistical significance, and overall model fit to evaluate how data source differences may influence substantive conclusions.\

### Table of Content

[Introduction](#introduction)

[Setup](#setup)

[Tool application](#tool-application)

[Conclusion and recommendations](#conclusion-and-recommendations)

# Introduction {#introduction}

The growing availability of big geodata allows survey researchers to enrich survey datasets with innovative geographic context measures. This development opens up new research opportunities and strengthens spatial perspectives within established theoretical frameworks. Against this backdrop, the use of crowdsourced geospatial data, such as OpenStreetMap (OSM), has increased substantially in survey-based social science research. However, linking OSM data to survey responses raises important questions about data quality and fitness for use, given the crowdsourced nature of the database. In particular, there is a lack of practical and standardized guidance for evaluating whether OSM data are sufficiently reliable for linkage with individual-level survey data.

OpenStreetMap is a large-scale, community-driven project that provides free and frequently updated geographic information on the built environment, land-use, transportation networks, and administrative boundaries across multiple spatial and temporal scales. Because OSM relies on volunteer contributions and was not originally designed for academic or survey research, it lacks a formal quality assurance methodology. At the same time, comparable official data sources are often unavailable, outdated, costly, or insufficiently detailed for many research applications, making OSM a practical and cost-effective alternative. Nevertheless, when integrating OSM data with survey information, systematic assessments of data quality are essential. Variations in data coverage and accuracy may affect substantive research findings, making evaluation of OSM data quality a first critical step in analyses.

This tool fills this critical void and serves as an innovative hands-on primer on OSM data quality checks in survey-based analyses. Specifically, it focuses on assessing the completeness and coverage of OpenStreetMap point of interest (POI) data when used to objectively proxy local public service provision in survey-based research.

As an illustrative application of the tool, we link perceived infrastructural deprivation to objective measures of public service provision. It is well-established that residents of under- and low-resourced areas tend to hold more negative views about access to basic infrastructure and services due to their continued exposure to disadvantaged infrastructural conditions. These conditions reflect a community's tangible resources and function as low-intensity informational cues that shape perceived accessibility and service provision (Baybeck & McClurg, 2005; Letki, 2008; McKay, 2019; Stroppe, 2023; Theunissen, 2024). Therefore, one central research question is whether living in an under-resourced area from a public service provision perspective is associated with more accentuated perceived infrastructural deprivation. Public service provision is defined as the availability of basic services and infrastructures within immediate vicinity: (1) healthcare (hospitals), (2) education (schools), and (3) food security (supermarkets). Perceived infrastructural deprivation is measured via a single item that reads, "society pays insufficient attention to ensuring access to basic infrastructure and services for people like me", from synthetic survey data from the German Longitudinal Election Study.

To address this question, we link survey responses on perceived infrastructural deprivation with information about respondents' public service provision in their immediate residential environment. Contextually, we focus on Germany, and we approximate residential environments using German municipalities. Research design-wise, augmenting survey data with objective measures of public service provision is fundamental to the research question, but it involves several complicated methodological decisions. These include (but are not limited to): (1) selecting the POI data source for proxies of public service provision and (2) evaluating its data quality. Here, data quality refers primarily to the completeness and coverage of POI data at the municipal level. This dimension is particularly suitable for POI-based measures of local public service provision, as completeness and coverage align with the aggregated nature of POI-based indicators, and incomplete or unevenly covered POI data may translate into measurement error at the aggregate level. For our analyses, objective measures of public service provision are drawn from two POI data sources: a German OpenStreetMap subset and official built environment data from the German Federal Agency for Cartography and Geodesy, which are treated as a data quality benchmark. We compare both datasets, using the official data as a gold standard to assess the quality of OSM measures for linked data analyses.

This tool is designed as a step-by-step workflow that guides users through the preparation, comparison, and linkage of OSM and official POI data with survey data, and demonstrates how differences in POI data sources can affect empirical results and substantive conclusions in survey-based analyses. By centering on POI-based measures of public service provision, the tool offers a focused and transferable approach to assessing OSM data quality that can be adapted to other concepts and data quality metrics. While illustrated using German data, the workflow is applicable wherever at least one comparatively reliable reference dataset is available.


# Data Prerequisites and Description

To run this tool or to apply to their own applications, researchers should need the following data:

* Georeferenced survey data with a geographic identifier (e.g., municipality, ZIP code, or grid cell ID) for each respondent's place of residence.

* Geographic unit geometries (e.g., shapefiles for municipalities, ZIP codes, or grid cells) used to link POI data with respondents' places of residence.

* A selected OSM POI data subset.

* Official POI data, if available.

In compliance with the above, the tool is based on: 

* Georeferenced synthetic survey data from the German Longitudinal Election Study 2021 with the municipalities of residence

* Shapefiles containing the geometries of German municipalities (2021)

* Shapefiles of points-of-interest (POI) data from the German subset of OpenStreetMap, obtained from Geofabrik (2025)

* Shapefiles of POI data from the Points of Interest Federal Dataset (POI-Bund) of the Federal Agency for Cartography and Geodesy (2022)

# Set-up

## Getting started

### Packages

Several R packages support geospatial data processing. We rely primarily on sp, a well-established geospatial package, and sf, a newer framework for managing spatial data. dplyr, ggplot2, rlang, and tibble are used for data wrangling, visualization, and general code support.

```{r}
# Install required packages  

# install.packages(c(
#   "dplyr",
#   "ggplot2",
#   "rlang",
#   "sf",
#   "sp",
#   "tibble"
# ))

```

```{r, echo=FALSE, results="hide", message=FALSE, warning=FALSE}
# Load required packages

library(dplyr) # For data manipulation
library(ggplot2) # For data visualization
library(rlang)  # For code support and code infrastructure management
library(sf) # For handling spatial (geometric) data, established package
library(sp) # For handling spatial (geometric) data, more recent package
library(tibble) # For creating and managing tibbles (special types of data frames)

library(purrr)
library(stringr)
library(tidygeocoder)
library(nngeo)
```

```{r}
# specify the path in which shapefiles are located 

base <- "C:/Users/daria/Desktop/OSM_data_2025" 

```

### Read in Synthetic Survey and Geospatial Data on German Municipalities

```{r}
# TO DO: SURVEY XXX
```

```{r, warning=FALSE}

# TO DO MUNICIPALITIES: DATA DESCRIPTION

german_municipalities <- st_read(file.path(base, "municipalites_2021_epsg4326.shp"))

# check coordinate reference system
st_crs(german_municipalities)  

# inspect attributes
head(german_municipalities)  
```

# Tool application {#tool-application}

# Part One: Getting Started with OSM POI Data

### Obtain OSM POI data: A Geofabrik-based Approach

There are many ways to access OSM data. Users can request custom subsets through the Overpass API, use the osmdata R package, download OSM shapefile extracts from Geofabrik, or rely on web-based services, such as Protomaps, BBBike, Geoapify, and similar platforms. All of these sources draw from the global OSM database, but they differ in their level of detail, geographic coverage, and update frequency. For beginners, as well as for more experienced users who prefer working with spatial files, we recommend starting with the shapefiles provided by Geofabrik. Compared to other OSM data providers, Geofabrik offers clean, well-structured, and de-anonymized datasets that include geometries, place names, coordinates, built environment feature classes, and other key tags. The attribute set is streamlined and comprehensive, so the shapefiles are suited both for users new to OSM and for the needs of this tool.

::: {.callout-note title="FYI"}

How to obtain shapefiles from Geobfabrik? For the sake of brevity, we omit a detailed discussion of how to obtain the shapefiles and instead refer users to the designated instructional script (see Geofabrik_data_access_instruction.Rmd) and accompanying video demonstrations (see X). 

:::

### Read in OSM POI Data

Once all the shapefiles are obtained, we can read them into R. First, the files are unzipped and their file paths are specified so they can be accessed within the R environment. Because POI in OSM may be represented using different geometries, both point and polygon layers are read to ensure complete coverage of POI features. Point features are defined by longitude and latitude coordinates representing a single location (e.g., a school or hospital), while polygon features represent area extents defined by multiple coordinates forming closed shapes (e.g., hospital complexes or supermarket buildings). Reading both layers ensures that all relevant OSM POI representations are captured. 

A complication arises from the fact that there is no single shapefile download for Germany. Instead, the shapefiles are organized by the German 16 federal states and administrative areas. Below, we extract OSM data for each federal state or administrative area by reading in their respective shapefiles.

```{r, results="hide", message=FALSE}

# define objects corresponding to each shapefile

# NB: Germany is organized by its 16 federal states, so there is no single shapefile download for the whole country.

files <- c(  
  arnsberg_regbez_poi = "arnsberg-regbez-latest-free.shp",
  brandenburg_with_berlin_regbez_poi = "brandenburg_with_berlin-latest-free.shp",
  detmold_regbez_poi = "detmold-regbez-latest-free.shp",
  duesseldorf_regbez_poi = "duesseldorf-regbez-latest-free.shp",
  freiburg_regbez_poi = "freiburg-regbez-latest-free.shp",
  hamburg_regbez_poi = "hamburg-latest-free.shp",
  hessen_regbez_poi = "hessen-latest-free.shp",
  karlsruhe_regbez_poi = "karlsruhe-regbez-latest-free.shp",
  koeln_regbez_poi = "koeln-regbez-latest-free.shp",
  mecklenburg_vorpommern_regbez_poi = "mecklenburg-vorpommern-latest-free.shp",
  mittelfranken_regbez_poi = "mittelfranken-latest-free.shp",
  muenster_regbez_poi = "muenster-regbez-latest-free.shp",
  niederbayern_regbez_poi = "niederbayern-latest-free.shp",
  niedersachsen_with_bremen_regbez_poi = "niedersachsen_with_bremen-latest-free.shp",
  oberbayern_regbez_poi = "oberbayern-latest-free.shp",
  oberfranken_regbez_poi = "oberfranken-latest-free.shp",
  oberpfalz_regbez_poi = "oberpfalz-latest-free.shp",
  rheinland_pfalz_regbez_poi = "rheinland-pfalz-latest-free.shp",
  sachsen_anhalt_regbez_poi = "sachsen-anhalt-latest-free.shp",
  saarland_regbez_poi = "saarland-latest-free.shp",
  sachsen_regbez_poi = "sachsen-latest-free.shp",
  schleswig_holstein_regbez_poi = "schleswig-holstein-latest-free.shp",
  schwaben_regbez_poi = "schwaben-latest-free.shp",
  stuttgart_regbez_poi = "stuttgart-regbez-latest-free.shp",
  thueringen_regbez_poi = "thueringen-latest-free.shp",
  tuebingen_regbez_poi = "tuebingen-regbez-latest-free.shp",
  unterfranken_regbez_poi = "unterfranken-latest-free.shp"
)

# read shapefiles for each administrative area, point layer 

for (nm in names(files)) { 
  assign(
    nm,
    st_read(
      dsn = file.path(base, files[[nm]]),
      layer = "gis_osm_pois_free_1", # here: point layer
      quiet = TRUE
    )
  )
}

# read shapefiles for each administrative area, polygon layer 

for (nm in names(files)) {  
  assign(
    paste0(nm, "_poly"),
    st_read(
      dsn = file.path(base, files[[nm]]),
      layer = "gis_osm_pois_a_free_1", # here: polygon layer
      quiet = TRUE
    )
  )
}

# save as .RData as to make it more convenient to work with

save.image("OSM_raw_POI_data.RData")
```

### Extract Public Provision Proxies from OSM 

The workflow below extracts public provision proxies from OSM by filtering, summarizing, and combining both point-based and polygon-based POI datasets. Administrative area-specific identifiers are derived from object names, allowing all area-specific datasets to be stacked into a single nationwide dataset. The workflow also computes frequency counts of each proxy type by administrative area and geometry type (points and polygons), and finally merges point and polygon features using their shared attributes to produce a unified, nationwide OSM-based dataset of public provision proxies across Germany.

```{r}
# define OSM feature class that would match public provision proxies 

public_provision_poi <- c("school", "supermarket", "hospital")

# create a helper function to subset the OSM files by the feature class of school, supermarket, hospital

subset_poi <- function(x, keep = public_provision_poi) {
  dplyr::filter(x, fclass %in% keep)
}
```

We create two helper functions to filter each administrative area-pecific OSM dataset to retain only schools, supermarkets, and hospitals, derive an area identifier from the object name by removing the suffix, row-bind all regions into a single combined dataset, and produce summary counts by feature class and administrative-area.

```{r}
# helper function to stack all features into one sf table

subset_and_stack <- function(poi_list, suffix_to_remove) {
  imap_dfr(poi_list, ~ subset_poi(.x) %>%
             mutate(region = str_remove(.y, suffix_to_remove)))
}


# helper function to produce summary counts by feature class and administrative-area.
fclass_freq <- function(poi_list, suffix_to_remove) {
  imap_dfr(poi_list, ~ subset_poi(.x) %>%
             st_drop_geometry() %>%
             count(fclass, name = "n") %>%
             mutate(region = str_remove(.y, suffix_to_remove)))
}

```

In this step, we first collect all administrative area-specific OSM point objects whose names end with _regbez_poi into a named list, using pattern matching and the mget() function to retrieve them from the environment. This list is then passed to helper functions that summarize the number of schools, supermarkets, and hospitals per administrative area and stack all regional datasets into a single nationwide point dataset while retaining region identifiers.

```{r}
# get point objects into a list 
poi_list_points <- mget(ls(pattern = "_regbez_poi$")) |> as.list()

# summarize counts
poi_points_counts <- fclass_freq(poi_list_points, "_regbez_poi$")
print(head(poi_points_counts))

# stack and summarize counts
poi_points_all <- subset_and_stack(poi_list_points, "_regbez_poi$")

# per feature class, nationwide count
table(poi_points_all$fclass)

# overall, all points, nationwide count
nrow(poi_points_all) 
```

Second, the same logic is applied to polygon-based POIs.

```{r}
# get polygon objects into a list
poi_list_polys <- mget(ls(pattern = "_regbez_poi_poly$")) |> as.list()


# summarize counts
poi_polys_counts <- fclass_freq(poi_list_polys, "_regbez_poi_poly$")
print(head(poi_polys_counts))


# stack polygons into one dataset
poi_polys_all <- subset_and_stack(poi_list_polys, "_regbez_poi_poly$")


# per feature class, nation-wide count
table(poi_polys_all$fclass)


# overall, all polygons, nation-wide count
nrow(poi_polys_all)
```

Next, a nationwide OSM-based dataset of public provision proxies across Germany is produced by combining the filtered and stacked point-based and polygon-based POI datasets, retaining only shared attributes to ensure consistency across geometry types.

```{r}
common_cols <- intersect(names(poi_polys_all), names(poi_points_all))

germany_poi_all_combined <- bind_rows(
  poi_polys_all[, common_cols],
  poi_points_all[, common_cols]
)

# per feature class, nation-wide count
table(germany_poi_all_combined$fclass)

# per feature class and per region
region_fclass_counts <- germany_poi_all_combined |>
sf::st_drop_geometry() |>
dplyr::count(region, fclass, name = "n") |>
dplyr::arrange(region, fclass)

print(head(region_fclass_counts))

# overall, nation-wide count
nrow(germany_poi_all_combined) 
```

### Assign POI Data to German Municipalities

Now that we have obtained and extracted public provision proxies across Germany from OSM, we need to assign each school, supermarket, or hospital to a municipality. This will ensure that, later on, we can link these proxies to survey responses. To do so, we will use a matching key, namely, respondents' municipality as a shared geographical unit across the data sources, such as the municipality, which is assigned to respondents based on their place of residence. 

We also ensure that the POI data matches coordinate reference system (CRS) that of the German municipality polygons. This step is essential because spatial overlays are only geometrically meaningful when all spatial objects are expressed in a common CRS. Mismatched CRS can otherwise lead to failed matches.

The code then identifies which POI geometries are polygons or multipolygons and replaces those with their centroids (i.e., the most central pair of longitude and latitude) so that all features can be treated as points for spatial overlay with the German municipality polygons. Centroid reduction is chosen primarily for data simplification reasons: it allows all POI geometries (points and (multi)polygons) to be represented in a uniform point format.

We then perform a spatial join to attach municipality identifiers and attributes to each POI by checking whether each POI point lies within a municipality polygon (point-in-polygon overlay). Finally, we assess match quality by counting the number of POIs that could not be assigned to any municipality, which may occur due to boundary effects.

```{r}

# force sf object
germany_poi_all_combined <- st_as_sf(germany_poi_all_combined)

# ensure CRS is compatiable across data sources
st_crs(germany_poi_all_combined) <- st_crs(german_municipalities)

# identify polygon geometries
geom_type <- st_geometry_type(germany_poi_all_combined)

is_polygon <- geom_type %in% c("POLYGON", "MULTIPOLYGON")

# centroid reduction

# replace polygons with their centroids, keep points as are

germany_poi_all_combined$geometry[is_polygon] <-
  st_centroid(germany_poi_all_combined$geometry[is_polygon])

sf_use_s2(FALSE) # supress errors coming from st_within, force municipality assignment

# overlay OSM public provision proxies with municipalities

poi_with_municipalities <- st_join(
  germany_poi_all_combined,
  german_municipalities,
  join = st_within,
  left = TRUE
)

# Check non-matches

sum(is.na(poi_with_municipalities$mun_id))

```

We identified that 205 POI were not matched with a municipality. To reveal the reason, we reverse-geocode the unmatched POI. This allows to further diagnose whether the unmatched POI lie outside Germany (e.g., OSM-related error) or artifacts stemming from the point-in-polygon/municipality matching procedure.

```{r}
poi_na <- poi_with_municipalities[is.na(poi_with_municipalities$mun_id), ]

coords <- st_coordinates(poi_na)

poi_na$lon <- coords[, "X"]
poi_na$lat <- coords[, "Y"]

poi_na_rg <- poi_na %>%
  reverse_geocode(
    lat = lat,
    long = lon,
    method = "arcgis",
    address = address, 
    min_time = 1)

poi_na_rg$country_code <- str_extract(str_trim(poi_na_rg$address), "[A-Z]{3}$")

table(poi_na_rg$country_code)
```

The results show that many POI could not be assigned to German municipalities because they were actually located in neighboring countries. Most of these POI are in Czechia (51), Poland (33), Switzerland (47), Austria (32), and France (23) as well as in the Netherlands, Belgium, Luxembourg, and Denmark. This pattern suggests that the unmatched observations are primarily driven by POI lying outside Germany, reflecting OSM (positional) accuracy errors and administrative boundary effects, rather than by errors in the spatial join. We therefore drop the unmatched POI, as they fall outside German administrative boundaries and are not relevant for the analysis.

```{r}
poi_with_municipalities_ger <- poi_with_municipalities[!is.na(poi_with_municipalities$mun_id), ]
```

### Deduplicate POI Data 

Because OSM data are not created for academic research and do not qualify as scientific data, they are not subject to rigorous quality control before collection and do not follow strict data collection standards (e.g., formal codebooks or standardized classification rules). We therefore recommend screening the data for duplicate records. Duplicates can arise, for example, when the same school is mapped both as a point and as a polygon, or when it is mistakenly recorded multiple times in the same format. Conducting these basic sanity checks helps identify and limit coverage errors that result from human data entry.

The deduplication procedure begins by re-projecting all POI from geographic coordinates (degrees) to a projected CRS measured in meters (i.e., EPSG:25832). This re-projection enables accurate distance calculations. Using the projected data, a nearest-neighbor search is conducted in which each point is compared to itself and its closest neighboring point. Neighboring points located within a maximum distance of one meter are flagged as potential duplicates. From these results, all candidate duplicate point pairs are constructed, excluding self-matches and retaining each pair only once. The second point in each identified duplicate pair is then classified as redundant and removed from the original dataset. This process yields a deduplicated POI dataset in which each remaining point represents a unique location.

```{r}
# reformat from degrees to meters 
poi_m <- st_transform(poi_with_municipalities_ger, 25832)

# find nearest neighbors within 1 meter 
nn <- st_nn(poi_m, poi_m, k = 2, maxdist = 1, returnDist = TRUE)

# create duplicate pairs 
dup_pairs <- tibble(
  i = rep(seq_along(nn$nn), lengths(nn$nn)),
  j = unlist(nn$nn)
) %>%
  filter(i != j) %>%
  mutate(a = pmin(i, j), b = pmax(i, j)) %>%
  distinct(a, b)

# identify duplicates 
to_drop <- unique(dup_pairs$b)

# deduplicate
poi_with_municipalities_ger_dedup <- poi_with_municipalities_ger[-to_drop, ]

# compare before and after

# total POI before
nrow(poi_with_municipalities_ger)

# total POI after
nrow(poi_with_municipalities_ger_dedup)

# total schools, supermarkets, hospitals before
table(poi_with_municipalities_ger$fclass)

# total schools, supermarkets, hospitals after
table(poi_with_municipalities_ger_dedup$fclass)

```

Before deduplication, the dataset contained 72704 points in total. After removing duplicates, the number of points was reduced to 72290. This reduction is also visible across POI categories. The number of hospitals decreased from 2403 to 2388 (-15), schools from 36279 to 36072 (-207), and supermarkets from 34022 to 33830 (-192). 

# Part Two: Obtain official POI data: A POI-Bund-based Approach

The tool is based on the the POI-Bund data. It is an official points-of-interest dataset provided by the Federal Agency for Cartography and Geodesy (BKG). It is based on geocoded POI address lists obtained from official sources or from independent research conducted by the BKG in 2022. For schools, address lists for each federal state were obtained from state statistical authorities or other state agencies responsible for schools. For hospitals, address lists were obtained from the Institute for the Hospital Remuneration System (InEK) that maintains the official registry of all hospitals authorized to provide inpatient care within the national hospital financing system. For supermarkets, address lists were obtained from gb consite, a commercial organization specializing in web-based geomarketing and logistics geoservices. 

::: {.callout-note title="FYI"}
All public provision proxies, namely hospitals, schools, and supermarkets, were already georeferenced with a German municipality ID. Therefore, it was not necessary to perform a spatial overlay procedure. However, if other official built environment data are available but not georeferenced, the above procedure developed for georeferencing OSM data can be applied as well. Each public provision POI from the POI-Bund dataset is unique.
:::

```{r}
base2 <- "C:/Users/daria/Desktop/POI_Bund"


# define objects corresponding to each shapefile

files2 <- c(
  hospitals_de = "hospitals_cleaned.shp",
  schools_de = "schools.shp",
  supermarkets_de = "supermarkets_cleaned.shp"
)


# read shapefiles

for (nm in names(files2)) {
  assign(
    nm,
    st_read(dsn = file.path(base2, files2[[nm]]), quiet = TRUE)
  )
}

save(
  hospitals_de,
  schools_de,
  supermarkets_de,
  file = "POI_Bund_data.RData"
)

# create a nation-wide official POI dataset

poi_bund_stacked <- bind_rows(
  hospitals_de %>%
    mutate(poi_type = "hospital"),
  
  
  schools_de %>%
    mutate(poi_type = "school"),
  
  
  supermarkets_de %>%
    mutate(poi_type = "supermarket")
)

table(poi_bund_stacked$poi_type)
```

# Part Three: OSM Data Quality Checks 

## Coverage Evaluation

A critical step in using OSM data for proxiyng public service provision is the evaluation of coverage errors. This step addresses whether OSM-based public service provision indicators may accurately numerically capture the POI they are intended to proxy, and whether potential errors in coverage (over- or undercoverage) may shape substantive conclusion. As we have pointed out earlier, coverage is particularly relevant for POI-based indicators because these measures are typically aggregated to neighborhoods or other administrative units: uneven or incomplete POI coverage can therefore induce measurement error at the aggregate level.

Following the conceptualization proposed by Dementeva (2025), coverage in OSM can be understood as the spatial analogue of coverage error in survey sampling. In this perspective, the "population" consists of real-world public service provision facilities (e.g., all schools, supermarkets and hospitals in Germany), while the OSM dataset aims to represent that population. Coverage is assessed by comparing the actual presence of public service provision features with their representation in an OSM subset. More formally, coverage error in OSM consists of two components: (1) errors of omission occur when real-world features are missing from OSM. These errors correspond to undercoverage, for example, when an existing school or clinic is not included in the database; (2) errors of commission arise when OSM contains excessive and duplicated  features. These errors are consistent with overcoverage, such as when a single facility is recorded multiple times or when a feature is mapped although it does not exist in reality.

In this part of the tool, OSM-based POI measures are benchmarked against official built environment data from the German Federal Agency for Cartography and Geodesy, which are treated as a gold standard. By comparing counts and distributions of public service facilities across the two datasets and German municipalities, the tool enables researchers to quantify and visualize under- and overcoverage in OSM and to critically assess the suitability of OSM data for linking with survey responsess. In particular, below, for each public provision service proxy, we count the number of POI in each data source. We visualize these counts using side-by-side bar charts, which allows to directly compare coverage across categories and identify where the two datasets converge or differ in their coverage of public service provision proxies.

```{r}
# compare counts

combined <- bind_rows(
  poi_bund_stacked %>%
    select(category = poi_type) %>%
    mutate(dataset = "poi_bund_stacked"),
  
  
  poi_with_municipalities_ger_dedup %>%
    select(category = fclass) %>%
    mutate(dataset = "poi_with_municipalities")
)


ggplot(combined, aes(x = category, fill = dataset)) +
  geom_bar(position = "dodge") +
  scale_fill_manual(
    values = c(
      "poi_bund_stacked" = "#014AAD",
      "poi_with_municipalities" = "#CBDDFE"
    ),
    labels = c(
      "poi_bund_stacked" = "Offical POI Data: POI-Bund",
      "poi_with_municipalities" = "German OpenStreetMap Data"
    )
  ) +
  scale_y_continuous(
    limits = c(0, 40000),
    labels = scales::label_comma(big.mark = ".", decimal.mark = ",")
  ) +
  labs(
    x = "Public Servic Provision Proxies",
    y = "POI Count",
    fill = "Dataset"
  ) +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))

```

The figure shows a side-by-side comparison of POI counts for three public service provision proxies, hospitals, schools, and supermarkets, across two datasets, official POI-Bund data (dark blue) and German OSM data (light blue). Starting with hospitals, the official POI-Bund data shows slightly more hospitals than OSM, but the difference is small, suggesting broadly similar coverage for this service type. For schools, OSM reports a noticeably larger number of facilities than POI-Bund. A similar pattern appears for supermarkets. It is important to note that these (rather small) discrepancies are not due to duplicated features, as this nuisance factor was addressed early on (see "Deduplicate POI data").

These patterns, however, may indicate that OSM tends to slightly overcover certain public service proxies, likely due to the nature of volunteer-based data collection and differences in data tagging and built environment feature classification conventions. For instance, if a school consists of multiple campuses, POI-Bund may record it as a single institution, whereas OSM contributors might map each campus individually. Similarly, OSM may overcapture supermarkets because volunteers can record street-level information directly on the ground, while POI-Bund relies primarily on web-based address listings, which may omit some localized entries. Therefore, the coverage discrepancies may stem from the fact that the datasets are not fully conceptually equivalent in their operational definitions of schools, hospitals, and supermarkets, nor in how they numerically record and document these features.

Overall, however, the two datasets largely converge in their representation of public service provision, particularly in terms of the distribution across service categories at the nationwide level. This suggests that, despite possible systematic differences in data collection and production practices, both data sources provide a broadly consistent picture of public service coverage in Germany. This may tentatively indicate that the two datasets can be used interchangeably for measuring proxies of public service provision, despite their conceptual inequivalence.

Next, we compare the spatial distribution of public service provision across data sources by mapping POI counts at the municipality level. For each dataset, we aggregate points of interest by municipality and service type, then join these counts to municipal boundary geometries. We visualize the results using faceted choropleth maps, with each panel representing a different public service proxy and municipalities shaded by the POI counts. This spatial comparison helps to assess whether POI-Bund and OSM not only differ in overall counts, but also in how public service provision is spatially distributed across municipalities and whether the spatial distribution is relatively the same across the data sources.

```{r}
# compare maps

counts_osm <- poi_with_municipalities_ger_dedup %>%
  count(mun_id, fclass, name = "poi_count") %>%
  arrange(mun_id, desc(poi_count))

counts_bund <- poi_bund_stacked  %>%
  count(mun_id, poi_type, name = "poi_count") %>%
  arrange(mun_id, desc(poi_count))

poi_bund_with_mun_geom <- counts_bund %>%
  st_drop_geometry() %>%
  left_join(
    german_municipalities %>% select(mun_id, geometry),
    by = "mun_id"
  ) %>%
  st_as_sf()

poi_osm_with_mun_geom <- counts_osm %>%
  st_drop_geometry() %>%
  left_join(
    german_municipalities %>% select(mun_id, geometry),
    by = "mun_id"
  ) %>%
  st_as_sf()

```

```{r}
ggplot(poi_bund_with_mun_geom) +
  geom_sf(aes(fill = poi_count), color = NA) +
  facet_wrap(~ poi_type) +
  scale_fill_gradient(
    low = "#deebf7",
    high = "#08306b",
    trans = "sqrt",
    limits = c(0, 1500),
    na.value = "grey95"
  ) +
  theme_minimal() +
  labs(
    title = "Public Provision Counts by Type and Municipality, Germany",
    subtitle = "Official POI Data: POI-Bund",
    fill = "POI count"
  )
```
```{r}
ggplot(poi_osm_with_mun_geom) +
  geom_sf(aes(fill = poi_count), color = NA) +
  facet_wrap(~ fclass) +
  scale_fill_gradient(
    low = "#deebf7",
    high = "#08306b",
    trans = "sqrt",
    limits = c(0, 1500),
    na.value = "grey95"
  ) +
  theme_minimal() +
  labs(
    title = "Public Provision Counts by Type and Municipality, Germany",
    subtitle = "OSM POI Data",
    fill = "POI count"
  )
```

Across both figures, the spatial patterns of public service provision look very similar in POI-Bund and OSM. For all three service types, higher POI counts are consistently concentrated in densely populated and urbanized areas, especially around major metropolitan regions. This suggests that both datasets point to the same municipalities as key hubs of public service provision, indicating strong agreement in the relative spatial distribution of services across Germany. Importantly, there are no major regions where one dataset shows extensive coverage while the other shows none, and rural areas are represented in much the same way in both datasets. Overall, the maps show a high degree of convergence between POI-Bund and OSM in how public service provision proxies are distributed across space.

Taken together, this convergence increases confidence in using OSM data as a reliable source for capturing public service provision proxies, even though there might be critical differences in how data are collected, tagged, and recorded in OSM compared to the official built environment data.

# Part Four: Link to Survey Data and Run Models

 TO DO XXX
 


# Conclusion, Recommendations and Future Work {#conclusion-recommendations-future-work}

The goal of this tool was to address a critical gap by providing an innovative, hands-on primer for assessing OSM data quality in survey-based analyses. The tool focused on evaluating the coverage of OSM POI data when used as an objective proxy for local public service provision in linked survey research and how differences in coverage may propagate into substantive conclusions.

First, we demonstrated that OSM-based POI data and official built environment data offer largely comparable coverage of public service provision proxies at a nationwide and local levels. Second, the relatively small and negligible differences in coverage can be attributed to variations in data production processes and tagging logics. These differences reflect how OSM contributors and official data officers record, classify, and tag built environment features, as well as the specific rules applied when determining what can be defined as schools, hospitals, or supermarkets  both conceptually and geographically. Despite this conceptual non-equivalence across data sources, our results indicate that, for the purposes of our application, these POI datasets can be treated as interchangeable. Third, regression estimates derived from OSM and POI-Bund proxies yield highly similar results across all public service provision indicators and model specifications.

Overall, these findings strengthen confidence that substantive conclusions regarding the relationship between perceived infrastructural deprivation and objective measures of public service provision are largely insensitive to the choice of POI data source. Any analytical error arising from differences in coverage or conceptual definitions across datasets appears to be minimal. Accordingly, our study demonstrates that OSM and official POI data sources can be considered highly interchangeable in survey data linkage-based research, particularly when they are used to operationalize aggregated measures of built environment availability.

## Key Recommendations 

We outline several key methodological recommendations for researchers interested in augmenting survey data with OpenStreetMap (OSM) and addressing similar research questions.

* Carefully examine non-matches when linking OSM data to geographic units (e.g., municipalities, ZIP codes, grid cells).

Researchers should explicitly diagnose the sources of non-matches, distinguishing between technical linkage issues (such as incompatible geographic boundaries or projection mismatches) and data-related issues in OSM itself (including volunteer tagging errors, administrative misclassification, or cross-border effects).

* Deduplicate OSM data prior to analysis.

To minimize redundancy, researchers should systematically cross-check point and polygon layers and remove duplicate features. Spatial neighbor detection algorithms can be used to identify likely duplicates, applying very small distance thresholds (e.g., within 1 meter) to flag redundant POI.

* Become familiar with how POI are defined and classified in OSM.

When benchmarking OSM against official POI data, or when using OSM as a standalone source, researchers should carefully review OSM tagging schemes and community conventions. This understanding is essential for evaluating what OSM-based POIs can capture and where their conceptual limits lie.

* Where feasible, benchmark OSM against official POI data.

Researchers should conduct low-effort, aggregated comparisons with administrative or official built environment datasets to verify that OSM provides sufficient coverage. When official data are unavailable, alternative benchmarks, such as address lists of chain supermarkets or other reliable facility registries, can serve as useful reference points.

* Conduct robustness checks with respect to missing data imputation.

Sensitivity analyses should be used to assess whether substantive results are robust to different assumptions about missing data and imputation strategies, ensuring that conclusions are not driven by data preprocessing decisions and are relatively free from processing errors.

## Future Work 


# References


::: {.callout-note title="Custom Note Title"}
This can be additional information you want to provide and visually separate from your main text.
:::

```{=html}
<!-- Additional information can be included as callout blocks with titles, such as
"Be careful", "Good to know", or "Package-specific feature"-->
=======
---
title: "osmBias"
subtitle: "Bias in the Map, Bias in the Results? Validating OpenStreetMap POI Data for
Individual-Level Survey-Based Analysis"
author:
  - name: "Daria Dementeva"
  - name: "Anne-Kathrin Stroppe"
  - name: "author 3"
image: images/tool_icon.png #takes from a folder "images" in your github repository the tool icon file  
date: "`r format(Sys.Date(), '%B %d, %Y')`"
format:
  html: default
  pdf: default
# bibliography: references.bib
biblio-style: apa
---

# At a glance

**How do differences in point of interest (POI) data sources affect analytical results?** \
This tool offers a hands-on, step-by-step workflow to help users compare POI data from OpenStreetMap (OSM) with administrative POI and built environment datasets. The tutorial walks users through the following steps:\

**Step 1a: Prepare the OSM POI data**\
Access OSM POI data, load it into the R  environment, clean and standardize the OSM geometries, and assign POIs to administrative geographic units so they can be compared with official POI data.\

**Step 1b: Create comparable POI indicators**\
Construct the same POI-based measures (e.g., counts) using both OSM and official POI datasets.\

**Step 2: Assess the standalone quality of POI indicators: Coverage**\
Compare POI indicators to identify differences in coverage per administrative geographic unit.\

**Step 3: Link to survey data**\
Link POI-based measures from OSM and official data to survey responses at the respondent's administrative geographic unit of residence.\

**Step 4: Assess impacts on analytical results**\
Estimate parallel regression models using OSM-based and official POI-based indicators. Compare model coefficients, statistical significance, and overall model fit to evaluate how data source differences may influence substantive conclusions.\

### Table of Content

[Introduction](#introduction)

[Setup](#setup)

[Tool application](#tool-application)

[Conclusion and recommendations](#conclusion-and-recommendations)

# Introduction {#introduction}

The growing availability of big geodata allows survey researchers to enrich survey datasets with innovative geographic context measures. This development opens up new research opportunities and strengthens spatial perspectives within established theoretical frameworks. Against this backdrop, the use of crowdsourced geospatial data, such as OpenStreetMap (OSM), has increased substantially in survey-based social science research. However, linking OSM data to survey responses raises important questions about data quality and fitness for use, given the crowdsourced nature of the database. In particular, there is a lack of practical and standardized guidance for evaluating whether OSM data are sufficiently reliable for linkage with individual-level survey data.

OpenStreetMap is a large-scale, community-driven project that provides free and frequently updated geographic information on the built environment, land-use, transportation networks, and administrative boundaries across multiple spatial and temporal scales. Because OSM relies on volunteer contributions and was not originally designed for academic or survey research, it lacks a formal quality assurance methodology. At the same time, comparable official data sources are often unavailable, outdated, costly, or insufficiently detailed for many research applications, making OSM a practical and cost-effective alternative. Nevertheless, when integrating OSM data with survey information, systematic assessments of data quality are essential. Variations in data coverage and accuracy may affect substantive research findings, making evaluation of OSM data quality a first critical step in analyses.

This tool fills this critical void and serves as an innovative hands-on primer on OSM data quality checks in survey-based analyses. Specifically, it focuses on assessing the completeness and coverage of OpenStreetMap point of interest (POI) data when used to objectively proxy local public service provision in survey-based research.

As an illustrative application of the tool, we link perceived infrastructural deprivation to objective measures of public service provision. It is well-established that residents of under- and low-resourced areas tend to hold more negative views about access to basic infrastructure and services due to their continued exposure to disadvantaged infrastructural conditions. These conditions reflect a community's tangible resources and function as low-intensity informational cues that shape perceived accessibility and service provision (Baybeck & McClurg, 2005; Letki, 2008; McKay, 2019; Stroppe, 2023; Theunissen, 2024). Therefore, one central research question is whether living in an under-resourced area from a public service provision perspective is associated with more accentuated perceived infrastructural deprivation. Public service provision is defined as the availability of basic services and infrastructures within immediate vicinity: (1) healthcare (hospitals), (2) education (schools), and (3) food security (supermarkets). Perceived infrastructural deprivation is measured via a single item that reads, "society pays insufficient attention to ensuring access to basic infrastructure and services for people like me", from synthetic survey data from the German Longitudinal Election Study.

To address this question, we link survey responses on perceived infrastructural deprivation with information about respondents' public service provision in their immediate residential environment. Contextually, we focus on Germany, and we approximate residential environments using German municipalities. Research design-wise, augmenting survey data with objective measures of public service provision is fundamental to the research question, but it involves several complicated methodological decisions. These include (but are not limited to): (1) selecting the POI data source for proxies of public service provision and (2) evaluating its data quality. Here, data quality refers primarily to the completeness and coverage of POI data at the municipal level. This dimension is particularly suitable for POI-based measures of local public service provision, as completeness and coverage align with the aggregated nature of POI-based indicators, and incomplete or unevenly covered POI data may translate into measurement error at the aggregate level. For our analyses, objective measures of public service provision are drawn from two POI data sources: a German OpenStreetMap subset and official built environment data from the German Federal Agency for Cartography and Geodesy, which are treated as a data quality benchmark. We compare both datasets, using the official data as a gold standard to assess the quality of OSM measures for linked data analyses.

This tool is designed as a step-by-step workflow that guides users through the preparation, comparison, and linkage of OSM and official POI data with survey data, and demonstrates how differences in POI data sources can affect empirical results and substantive conclusions in survey-based analyses. By centering on POI-based measures of public service provision, the tool offers a focused and transferable approach to assessing OSM data quality that can be adapted to other concepts and data quality metrics. While illustrated using German data, the workflow is applicable wherever at least one comparatively reliable reference dataset is available.


# Data Prerequisites and Description

To run this tool or to apply to their own applications, researchers should need the following data:

* Georeferenced survey data with a geographic identifier (e.g., municipality, ZIP code, or grid cell ID) for each respondent's place of residence.

* Geographic unit geometries (e.g., shapefiles for municipalities, ZIP codes, or grid cells) used to link POI data with respondents' places of residence.

* A selected OSM POI data subset.

* Official POI data, if available.

In compliance with the above, the tool is based on: 

* Georeferenced synthetic survey data from the German Longitudinal Election Study 2021 with the municipalities of residence

* Shapefiles containing the geometries of German municipalities (2021)

* Shapefiles of points-of-interest (POI) data from the German subset of OpenStreetMap, obtained from Geofabrik (2025)

* Shapefiles of POI data from the Points of Interest Federal Dataset (POI-Bund) of the Federal Agency for Cartography and Geodesy (2022)

# Set-up

## Getting started

### Packages

Several R packages support geospatial data processing. We rely primarily on sp, a well-established geospatial package, and sf, a newer framework for managing spatial data. dplyr, ggplot2, rlang, and tibble are used for data wrangling, visualization, and general code support.

```{r}
# Install required packages  

# install.packages(c(
#   "dplyr",
#   "ggplot2",
#   "rlang",
#   "sf",
#   "sp",
#   "tibble"
# ))

```

```{r, echo=FALSE, results="hide", message=FALSE, warning=FALSE}
# Load required packages

library(dplyr) # For data manipulation
library(ggplot2) # For data visualization
library(rlang)  # For code support and code infrastructure management
library(sf) # For handling spatial (geometric) data, established package
library(sp) # For handling spatial (geometric) data, more recent package
library(tibble) # For creating and managing tibbles (special types of data frames)

library(purrr)
library(stringr)
library(tidygeocoder)
library(nngeo)
```

```{r}
# specify the path in which shapefiles are located 

base <- "C:/Users/daria/Desktop/OSM_data_2025" 

```

### Read in Synthetic Survey and Geospatial Data on German Municipalities

```{r}
# TO DO: SURVEY XXX
```

```{r, warning=FALSE}

# TO DO MUNICIPALITIES: DATA DESCRIPTION

german_municipalities <- st_read(file.path(base, "municipalites_2021_epsg4326.shp"))

# check coordinate reference system
st_crs(german_municipalities)  

# inspect attributes
head(german_municipalities)  
```

# Tool application {#tool-application}

# Part One: Getting Started with OSM POI Data

### Obtain OSM POI data: A Geofabrik-based Approach

There are many ways to access OSM data. Users can request custom subsets through the Overpass API, use the osmdata R package, download OSM shapefile extracts from Geofabrik, or rely on web-based services, such as Protomaps, BBBike, Geoapify, and similar platforms. All of these sources draw from the global OSM database, but they differ in their level of detail, geographic coverage, and update frequency. For beginners, as well as for more experienced users who prefer working with spatial files, we recommend starting with the shapefiles provided by Geofabrik. Compared to other OSM data providers, Geofabrik offers clean, well-structured, and de-anonymized datasets that include geometries, place names, coordinates, built environment feature classes, and other key tags. The attribute set is streamlined and comprehensive, so the shapefiles are suited both for users new to OSM and for the needs of this tool.

::: {.callout-note title="FYI"}

How to obtain shapefiles from Geobfabrik? For the sake of brevity, we omit a detailed discussion of how to obtain the shapefiles and instead refer users to the designated instructional script (see Geofabrik_data_access_instruction.Rmd) and accompanying video demonstrations (see X). 

:::

### Read in OSM POI Data

Once all the shapefiles are obtained, we can read them into R. First, the files are unzipped and their file paths are specified so they can be accessed within the R environment. Because POI in OSM may be represented using different geometries, both point and polygon layers are read to ensure complete coverage of POI features. Point features are defined by longitude and latitude coordinates representing a single location (e.g., a school or hospital), while polygon features represent area extents defined by multiple coordinates forming closed shapes (e.g., hospital complexes or supermarket buildings). Reading both layers ensures that all relevant OSM POI representations are captured.

```{r, results="hide", message=FALSE}

# define objects corresponding to each shapefile

files <- c(  
  arnsberg_regbez_poi = "arnsberg-regbez-latest-free.shp",
  brandenburg_with_berlin_regbez_poi = "brandenburg_with_berlin-latest-free.shp",
  detmold_regbez_poi = "detmold-regbez-latest-free.shp",
  duesseldorf_regbez_poi = "duesseldorf-regbez-latest-free.shp",
  freiburg_regbez_poi = "freiburg-regbez-latest-free.shp",
  hamburg_regbez_poi = "hamburg-latest-free.shp",
  hessen_regbez_poi = "hessen-latest-free.shp",
  karlsruhe_regbez_poi = "karlsruhe-regbez-latest-free.shp",
  koeln_regbez_poi = "koeln-regbez-latest-free.shp",
  mecklenburg_vorpommern_regbez_poi = "mecklenburg-vorpommern-latest-free.shp",
  mittelfranken_regbez_poi = "mittelfranken-latest-free.shp",
  muenster_regbez_poi = "muenster-regbez-latest-free.shp",
  niederbayern_regbez_poi = "niederbayern-latest-free.shp",
  niedersachsen_with_bremen_regbez_poi = "niedersachsen_with_bremen-latest-free.shp",
  oberbayern_regbez_poi = "oberbayern-latest-free.shp",
  oberfranken_regbez_poi = "oberfranken-latest-free.shp",
  oberpfalz_regbez_poi = "oberpfalz-latest-free.shp",
  rheinland_pfalz_regbez_poi = "rheinland-pfalz-latest-free.shp",
  sachsen_anhalt_regbez_poi = "sachsen-anhalt-latest-free.shp",
  saarland_regbez_poi = "saarland-latest-free.shp",
  sachsen_regbez_poi = "sachsen-latest-free.shp",
  schleswig_holstein_regbez_poi = "schleswig-holstein-latest-free.shp",
  schwaben_regbez_poi = "schwaben-latest-free.shp",
  stuttgart_regbez_poi = "stuttgart-regbez-latest-free.shp",
  thueringen_regbez_poi = "thueringen-latest-free.shp",
  tuebingen_regbez_poi = "tuebingen-regbez-latest-free.shp",
  unterfranken_regbez_poi = "unterfranken-latest-free.shp"
)

# read shapefiles for each administrative area, point layer 

for (nm in names(files)) { 
  assign(
    nm,
    st_read(
      dsn = file.path(base, files[[nm]]),
      layer = "gis_osm_pois_free_1", # here: point layer
      quiet = TRUE
    )
  )
}

# read shapefiles for each administrative area, polygon layer 

for (nm in names(files)) {  
  assign(
    paste0(nm, "_poly"),
    st_read(
      dsn = file.path(base, files[[nm]]),
      layer = "gis_osm_pois_a_free_1", # here: polygon layer
      quiet = TRUE
    )
  )
}

# save as .RData as to make it more convenient to work with

save.image("OSM_raw_POI_data.RData")
```

### Extract Public Provision Proxies from OSM 

The workflow below extracts public provision proxies from OSM by filtering, summarizing, and combining both point-based and polygon-based POI datasets. Administrative area-specific identifiers are derived from object names, allowing all area-specific datasets to be stacked into a single nation-wide dataset. The workflow also computes frequency counts of each proxy type by administrative area and geometry type (points and polygons), and finally merges point and polygon features using their shared attributes to produce a unified, nation-wide OSM-based dataset of public provision proxies across Germany.

```{r}
# define OSM feature class that would match public provision proxies 

public_provision_poi <- c("school", "supermarket", "hospital")

# create a helper function to subset the OSM files by the feature class of school, supermarket, hospital

subset_poi <- function(x, keep = public_provision_poi) {
  dplyr::filter(x, fclass %in% keep)
}
```

We create two helper functions to filter each administrative areaspecific OSM dataset to retain only schools, supermarkets, and hospitals, derive an area identifier from the object name by removing the suffix, row-bind all regions into a single combined dataset, and produce summary counts by feature class and administrative-area.

```{r}
# helper function to stack all features into one sf table

subset_and_stack <- function(poi_list, suffix_to_remove) {
  imap_dfr(poi_list, ~ subset_poi(.x) %>%
             mutate(region = str_remove(.y, suffix_to_remove)))
}


# helper function to produce summary counts by feature class and administrative-area.
fclass_freq <- function(poi_list, suffix_to_remove) {
  imap_dfr(poi_list, ~ subset_poi(.x) %>%
             st_drop_geometry() %>%
             count(fclass, name = "n") %>%
             mutate(region = str_remove(.y, suffix_to_remove)))
}

```

In this step, we first collect all administrative area-specific OSM point objects whose names end with _regbez_poi into a named list, using pattern matching and mget() to retrieve them from the environment. This list is then passed to helper functions that summarize the number of schools, supermarkets, and hospitals per administrative area and stack all regional datasets into a single nationwide point dataset while retaining region identifiers.

```{r}
# get point objects into a list 
poi_list_points <- mget(ls(pattern = "_regbez_poi$")) |> as.list()

# summarize counts
poi_points_counts <- fclass_freq(poi_list_points, "_regbez_poi$")
print(head(poi_points_counts))

# stack and summarize counts
poi_points_all <- subset_and_stack(poi_list_points, "_regbez_poi$")

# per feature class, nationwide count
table(poi_points_all$fclass)

# overall, all points, nationwide count
nrow(poi_points_all) 
```

Second, the same logic is applied to polygon-based POIs.

```{r}
# get polygon objects into a list
poi_list_polys <- mget(ls(pattern = "_regbez_poi_poly$")) |> as.list()


# summarize counts
poi_polys_counts <- fclass_freq(poi_list_polys, "_regbez_poi_poly$")
print(head(poi_polys_counts))


# stack polygons into one dataset
poi_polys_all <- subset_and_stack(poi_list_polys, "_regbez_poi_poly$")


# per feature class, nation-wide count
table(poi_polys_all$fclass)


# overall, all polygons, nation-wide count
nrow(poi_polys_all)
```

Next, a nationwide OSM-based dataset of public provision proxies across Germany is produced by combining the filtered and stacked point-based and polygon-based POI datasets, retaining only shared attributes to ensure consistency across geometry types.

```{r}
common_cols <- intersect(names(poi_polys_all), names(poi_points_all))

germany_poi_all_combined <- bind_rows(
  poi_polys_all[, common_cols],
  poi_points_all[, common_cols]
)

# per feature class, nation-wide count
table(germany_poi_all_combined$fclass)

# per feature class and per region
region_fclass_counts <- germany_poi_all_combined |>
sf::st_drop_geometry() |>
dplyr::count(region, fclass, name = "n") |>
dplyr::arrange(region, fclass)

print(head(region_fclass_counts))

# overall, nation-wide count
nrow(germany_poi_all_combined) 
```

### Assign POI Data to German Municipalities

Now that we have obtained and extracted public provision proxies across Germany from OSM, we need to assign each school, supermarket, or hospital to a municipality. This will ensure that, later on, we can link these proxies to survey responses using a matching key, namely,  a shared geographical unit across the data sources, such as the municipality, which is assigned to respondents based on their place of residence. 
We ensure that the POI data matches coordinate reference system that of the German municipality polygons. The code then identifies which POI geometries are polygons or multipolygons and replaces those with their centroids (i.e., the most central pair of longitude and latitude) so that all features can be treated as points for spatial overlay with the German municipality polygons. To avoid geometry-related errors during spatial operations, spherical geometry processing is disabled. A spatial join is then performed to attach municipality ID and attributes to each POI based on checking whether each POI point lies within a municipality polygon (i.e., point-in-polygon overlay). Finally, the code checks how many POIs could not be matched to any municipality by counting missing municipality identifiers. 

```{r}

# force sf object
germany_poi_all_combined <- st_as_sf(germany_poi_all_combined)

# ensure CRS is compatiable across data sources
st_crs(germany_poi_all_combined) <- st_crs(german_municipalities)

# identify polygon geometries
geom_type <- st_geometry_type(germany_poi_all_combined)

is_polygon <- geom_type %in% c("POLYGON", "MULTIPOLYGON")

# centroid reduction

# replace polygons with their centroids, keep points as are

germany_poi_all_combined$geometry[is_polygon] <-
  st_centroid(germany_poi_all_combined$geometry[is_polygon])

sf_use_s2(FALSE) # supress errors coming from st_within, force municipality assignment

# overlay OSM public provision proxies with municipalities

poi_with_municipalities <- st_join(
  germany_poi_all_combined,
  german_municipalities,
  join = st_within,
  left = TRUE
)

# Check non-matches

sum(is.na(poi_with_municipalities$mun_id))

```

We identified that 205 were not matched with a municipality. To reveal the reason, we reverse-geocode the unmatched POI. This allows to further diagnose whether the unmatched POI lie outside Germany (e.g., OSM-related error) or artifacts stemming from the point-in-polygon/municipality matching procedure.

```{r}
poi_na <- poi_with_municipalities[is.na(poi_with_municipalities$mun_id), ]

coords <- st_coordinates(poi_na)

poi_na$lon <- coords[, "X"]
poi_na$lat <- coords[, "Y"]

poi_na_rg <- poi_na %>%
  reverse_geocode(
    lat = lat,
    long = lon,
    method = "arcgis",
    address = address, 
    min_time = 1)

poi_na_rg$country_code <- str_extract(str_trim(poi_na_rg$address), "[A-Z]{3}$")

table(poi_na_rg$country_code)
```

This output shows that many POI were not assigned to German municipalities because they are actually located in neighboring countries. Most fall in Czechia (51), Poland (33), Switzerland (47), Austria (32), and France (23), as well as in the Netherlands, Belgium, Luxembourg, and Denmark. This indicates that the municipality unmatches are largely due to POI lying outside Germany (OSM-based error) rather than errors in the spatial join. We can delete the unmatched POI, knowing there are irrelevant and do not belong to Germany administratively.

```{r}
poi_with_municipalities_ger <- poi_with_municipalities[!is.na(poi_with_municipalities$mun_id), ]
```

### Deduplicate POI Data 

Since OSM data are not designed for academic purposes and do not constitute scientific data, they are not subject to rigorous data quality control prior to collection and do not adhere to strict data collection principles (e.g., codebooks or standardized assignment rules). We therefore recommend checking the data for duplicate entries. Such duplicates may occur, for example, when the same school is recorded both as a point and a polygon, or when it is erroneously documented multiple times as either a point or a polygon. These basic sanity checks help establish control over coverage errors arising from human data entry.

The deduplication procedure first re-projects all the POI from geographic coordinates in degrees to a projected coordinate reference system in meters (EPSG:25832), which allows exact distance calculations in meters. Using the re-projected data, a nearest-neighbor search is performed where each point is compared to itself and its closest-distance neighboring point, identifying neighbors that lie within a maximum distance of one meter. All candidate duplicate point pairs are constructed, excluding self-matches and keeping each pair only once. The second element of each duplicate pair is then marked as redundant, and these features are further removed from the original dataset. The result is a deduplicated POI dataset in which any point is a unique point.

```{r}
# reformat from degrees to meters 
poi_m <- st_transform(poi_with_municipalities_ger, 25832)

# find nearest neighbors within 1 meter 
nn <- st_nn(poi_m, poi_m, k = 2, maxdist = 1, returnDist = TRUE)

# create duplicate pairs 
dup_pairs <- tibble(
  i = rep(seq_along(nn$nn), lengths(nn$nn)),
  j = unlist(nn$nn)
) %>%
  filter(i != j) %>%
  mutate(a = pmin(i, j), b = pmax(i, j)) %>%
  distinct(a, b)

# identify duplicates 
to_drop <- unique(dup_pairs$b)

# deduplicate
poi_with_municipalities_ger_dedup <- poi_with_municipalities_ger[-to_drop, ]

# compare before and after

# total POI before
nrow(poi_with_municipalities_ger)

# total POI after
nrow(poi_with_municipalities_ger_dedup)

# total schools, supermarkets, hospitals before
table(poi_with_municipalities_ger$fclass)

# total schools, supermarkets, hospitals after
table(poi_with_municipalities_ger_dedup$fclass)

```
Before deduplication, the dataset contained 72704 points in total. After removing duplicates, the number of points was reduced to 72290. This reduction is also visible across POI categories. The number of hospitals decreased from 2403 to 2388 (-15), schools from 36279 to 36072 (-207), and supermarkets from 34022 to 33830 (-192). 

# Part Two: Obtain official POI data: A POI-Bund-based Approach

The tool is based on the the POI-Bund data. It is an official points-of-interest dataset provided by the Federal Agency for Cartography and Geodesy (BKG). It is based on geocoded POI address lists obtained from official sources or from independent research conducted by the BKG in 2022. Georeferencing of POI addresses was performed using the official BKG geocoding service. For schools, address lists for each federal state were obtained from state statistical authorities or other state agencies responsible for schools. For hospitals, address lists were obtained from the Institute for the Hospital Remuneration System (InEK) that maintains the official registry of all hospitals authorized to provide inpatient care within the national hospital financing system. For supermarkets, address lists were obtained from gb consite, a commercial organization specializing in web-based geomarketing and logistics geoservices. 

::: {.callout-note title="FYI"}
All public provision proxies, namely hospitals, schools, and supermarkets, were already georeferenced with a German municipality ID. Therefore, it was not necessary to perform a spatial overlay procedure. However, if other official built environment data are available but not georeferenced, the above procedure developed for georeferencing OSM data can be applied as well. Each public provision POI from the POI-Bund dataset is unique.
:::

```{r}
base2 <- "C:/Users/daria/Desktop/POI_Bund"


# define objects corresponding to each shapefile

files2 <- c(
  hospitals_de = "hospitals_cleaned.shp",
  schools_de = "schools.shp",
  supermarkets_de = "supermarkets_cleaned.shp"
)


# read shapefiles

for (nm in names(files2)) {
  assign(
    nm,
    st_read(dsn = file.path(base2, files2[[nm]]), quiet = TRUE)
  )
}

save(
  hospitals_de,
  schools_de,
  supermarkets_de,
  file = "POI_Bund_data.RData"
)

# create a nation-wide official POI dataset

poi_bund_stacked <- bind_rows(
  hospitals_de %>%
    mutate(poi_type = "hospital"),
  
  
  schools_de %>%
    mutate(poi_type = "school"),
  
  
  supermarkets_de %>%
    mutate(poi_type = "supermarket")
)

table(poi_bund_stacked$poi_type)
```

# Part Three: Compare Public Service Provision Coverage Across Data Sources

In this part, we directly compare public service provision coverage across data sources. We bring together two sources of POI data,  POI-Bund data and German OSM data, by harmonizing their public service provision categories and stacking them into a single dataset. For each public provision service proxy, we then count the number of POIs in each data source. We visualize these counts using side-by-side bar charts, which allows to directly compare coverage across categories and identify where the two datasets converge or differ in their coverage of public  service provision proxies.

```{r}
# compare counts

combined <- bind_rows(
  poi_bund_stacked %>%
    select(category = poi_type) %>%
    mutate(dataset = "poi_bund_stacked"),
  
  
  poi_with_municipalities_ger_dedup %>%
    select(category = fclass) %>%
    mutate(dataset = "poi_with_municipalities")
)


ggplot(combined, aes(x = category, fill = dataset)) +
  geom_bar(position = "dodge") +
  scale_fill_manual(
    values = c(
      "poi_bund_stacked" = "#014AAD",
      "poi_with_municipalities" = "#CBDDFE"
    ),
    labels = c(
      "poi_bund_stacked" = "Offical POI Data: POI-Bund",
      "poi_with_municipalities" = "German OpenStreetMap Data"
    )
  ) +
  scale_y_continuous(
    limits = c(0, 40000),
    labels = scales::label_comma(big.mark = ".", decimal.mark = ",")
  ) +
  labs(
    x = "Public Servic Provision Proxies",
    y = "POI Count",
    fill = "Dataset"
  ) +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))

```
The figure shows a side-by-side comparison of POI counts for three public service provision proxies, hospitals, schools, and supermarkets, across two datasets: official POI-Bund data (dark blue) and German OSM data (light blue). Starting with hospitals, the official POI-Bund data shows slightly more hospitals than OSM, but the difference is small, suggesting broadly similar coverage for this service type.For schools, OSM reports a noticeably larger number of facilities than POI-Bund. A similar pattern appears for supermarkets. 

These patterns may indicate that OSM tends to slightly overrepresent certain public service proxies, likely due to the nature of volunteer data collection and frequent updates. For instance, if a school consists of multiple campuses, POI-Bund may record it as a standalone institution, whereas OSM contributors might map each campus individually. Similarly, OSM may overcapture supermarkets, because volunteers can record street-level information directly on the ground, while POI-Bund relies primarily on web-based address listings, which may omit some localized entries.

Overall, however, the two datasets relatively converge in their representation of public service provision, particularly in terms of the  distribution across service categories at a nation-wide level. This suggests that despite systematic differences in data collection and production practices, both data sources provide a broadly consistent picture of public service coverage in Germany. This may tentatively suggest that the two can be used interchangeably for measruing proxies of public service provision.

Next, we compare the spatial distribution of public service provision across data sources by mapping POI counts at the municipality level. For each dataset, we aggregate points of interest by municipality and service type, then join these counts to municipal boundary geometries. We visualize the results using faceted choropleth maps, with each panel representing a different public service proxy and municipalities shaded by the POI counts. This spatial comparison helps to assess whether POI-Bund and OSM not only differ in overall counts, but also in how public service provision is spatially distributed across municipalities and whether the spatial distribution is relatively the same across the data sources.

```{r}
# compare maps

counts_osm <- poi_with_municipalities_ger_dedup %>%
  count(mun_id, fclass, name = "poi_count") %>%
  arrange(mun_id, desc(poi_count))

counts_bund <- poi_bund_stacked  %>%
  count(mun_id, poi_type, name = "poi_count") %>%
  arrange(mun_id, desc(poi_count))

poi_bund_with_mun_geom <- counts_bund %>%
  st_drop_geometry() %>%
  left_join(
    german_municipalities %>% select(mun_id, geometry),
    by = "mun_id"
  ) %>%
  st_as_sf()

poi_osm_with_mun_geom <- counts_osm %>%
  st_drop_geometry() %>%
  left_join(
    german_municipalities %>% select(mun_id, geometry),
    by = "mun_id"
  ) %>%
  st_as_sf()

```

```{r}
ggplot(poi_bund_with_mun_geom) +
  geom_sf(aes(fill = poi_count), color = NA) +
  facet_wrap(~ poi_type) +
  scale_fill_gradient(
    low = "#deebf7",
    high = "#08306b",
    trans = "sqrt",
    limits = c(0, 1500),
    na.value = "grey95"
  ) +
  theme_minimal() +
  labs(
    title = "Public Provision Counts by Type and Municipality, Germany",
    subtitle = "Official POI Data: POI-Bund",
    fill = "POI count"
  )
```
```{r}
ggplot(poi_osm_with_mun_geom) +
  geom_sf(aes(fill = poi_count), color = NA) +
  facet_wrap(~ fclass) +
  scale_fill_gradient(
    low = "#deebf7",
    high = "#08306b",
    trans = "sqrt",
    limits = c(0, 1500),
    na.value = "grey95"
  ) +
  theme_minimal() +
  labs(
    title = "Public Provision Counts by Type and Municipality, Germany",
    subtitle = "OSM POI Data",
    fill = "POI count"
  )
```
Across both figures, the spatial patterns of public service provision look very similar in POI-Bund and OSM. For all three service types, higher POI counts are consistently concentrated in densely populated and urbanized areas, especially around major metropolitan regions. This suggests that both datasets point to the same municipalities as key hubs of public service provision, indicating strong agreement in the relative spatial distribution of services across Germany. Importantly, there are no major regions where one dataset shows extensive coverage while the other shows none, and rural areas are represented in much the same way in both datasets. Overall, the maps show a high degree of convergence between POI-Bund and OSM in how public service provision proxies are distributed across space.

Taken together, this convergence increases confidence in using OSM data as a reliable source for capturing public service provision proxies, even though there are clear differences in how data are collected, produced, and recorded in OSM compared to official built environment data.


# Part Four: Link to Survey Data and Run Models

 TO DO XXX

# Conclusion and recommendations {#conclusion-and-recommendations}

# References


::: {.callout-note title="Custom Note Title"}
This can be additional information you want to provide and visually separate from your main text.
:::

```{=html}
<!-- Additional information can be included as callout blocks with titles, such as
"Be careful", "Good to know", or "Package-specific feature"-->
>>>>>>> ea369333be7647e9147fffed1212c0d5a433bbc7
```